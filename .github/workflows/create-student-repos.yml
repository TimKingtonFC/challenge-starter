name: Create Student Repo from Issue

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  create-student-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Parse command
        id: parse
        run: |
          if [[ "${{ github.event.issue.body }}" == /create-student-repo* ]]; then
            CMD="${{ github.event.issue.body }}"
          elif [[ "${{ github.event.comment.body }}" == /create-student-repo* ]]; then
            CMD="${{ github.event.comment.body }}"
          else
            echo "No /create-student-repo command found. Exiting. ${{ github.event.comment.body }} ${{ github.event.issue.body }}"
            exit 0
          fi
          # Extract username and project name
          STUDENT_GITHUB_USERNAME=$(echo $CMD | awk '{print $2}')
          PROJECT_NAME=$(echo $CMD | awk '{print $3}')
          if [[ -z "$STUDENT_GITHUB_USERNAME" || -z "$PROJECT_NAME" ]]; then
            echo "Malformed command. Usage: /create-student-repo <github-username> <project-name>"
            exit 0
          fi
          echo "student_github_username=$STUDENT_GITHUB_USERNAME" >> $GITHUB_OUTPUT
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT

      - name: Create student repo from template
        id: create_repo
        if: steps.parse.outputs.student_github_username && steps.parse.outputs.project_name
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADMIN_GITHUB_TOKEN }}
          script: |
            const student = '${{ steps.parse.outputs.student_github_username }}';
            const projectName = '${{ steps.parse.outputs.project_name }}';
            const template = process.env.GITHUB_REPOSITORY; // owner/repo (current repo)
            const repoName = `${projectName}-${student}`;
            const [owner, templateRepo] = template.split('/');

            // Create the repo from template under our account
            const repo = await github.rest.repos.createUsingTemplate({
              template_owner: owner,
              template_repo: templateRepo,
              owner: owner, // Create under our account, not the student's
              name: repoName,
              private: true,
              include_all_branches: false,
              description: `${projectName} challenge repo for ${student}`
            });

            // Add student as admin collaborator
            await github.rest.repos.addCollaborator({
              owner: owner, // Our account owns the repo
              repo: repoName,
              username: student,
              permission: 'admin'
            });

            core.setOutput('repo_url', repo.data.html_url);
            core.setOutput('student_repo', `${owner}/${repoName}`);
            core.setOutput('project_name', projectName);

      - name: Set PROJECT_NAME variable in student repo
        if: steps.create_repo.outputs.student_repo && steps.create_repo.outputs.project_name
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.ADMIN_GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ steps.create_repo.outputs.student_repo }}/actions/variables \
            -d '{"name": "PROJECT_NAME", "value": "${{ steps.create_repo.outputs.project_name }}"}'

      - name: Trigger deliver-starter workflow in main repo
        if: steps.create_repo.outputs.student_repo && steps.create_repo.outputs.project_name
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.ADMIN_GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.everest-preview+json" \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ steps.create_repo.outputs.project_name }}/dispatches \
            -d '{"event_type": "deliver-starter", "client_payload": {"student_repo": "${{ steps.create_repo.outputs.student_repo }}", "requesting_part": 1}}'

      - name: Comment with result
        if: steps.create_repo.outputs.repo_url
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            const repo_url = '${{ steps.create_repo.outputs.repo_url }}';
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number,
              body: `Student repository created: ${repo_url}`
            });
